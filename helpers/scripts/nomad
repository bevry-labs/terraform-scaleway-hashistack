#!/usr/bin/env bash
set -ueE -o pipefail
cd "$(dirname "$0")"

# Locals
service="nomad"
user="nomad_user"
group="$user"

# Variables
nomad_version="$(tr -d '\n' < ../data/nomad_version)"
nomad_type="$(tr -d '\n' < ../data/nomad_type)"
nomad_token="$(tr -d '\n' < ../data/nomad_token)"
nomad_expect="$(tr -d '\n' < ../data/nomad_expect)"
private_ip="$(tr -d '\n' < ../data/private_ip)"
region="$(tr -d '\n' < ../data/region)"

# Files
temp="$(mktemp -d)"
conf_file="$temp/$service.conf"
json_file="$temp/$service.json"

# https://www.nomadproject.io/docs/agent/configuration/index.html
# https://www.nomadproject.io/guides/cluster/automatic.html
# https://www.nomadproject.io/docs/agent/configuration/consul.html
# https://www.nomadproject.io/docs/vault-integration/index.html
# "bootstrap_expect": $nomad_expect,
echo "Writing nomad configuration..."
cat > "$conf_file" <<EOF
[Unit]
Description=nomad agent
Requires=network-online.target
After=network-online.target

[Service]
Restart=on-failure
EnvironmentFile=-/etc/sysconfig/nomad
ExecStart=/usr/local/bin/nomad agent -config=/etc/systemd/system/nomad.d
ExecReload=/bin/kill -HUP \$MAINPID
KillSignal=SIGTERM
User=${user}
Group=${group}

[Install]
WantedBy=multi-user.target
EOF
if test "$nomad_type" = "master"; then
	cat > "$json_file" <<EOF
{
	"data_dir": "/opt/nomad/data",
	"server": {
		"enabled": true,
		"bootstrap_expect": ${nomad_expect}
	},
	"consul": {},
	"vault": {
		"enabled": true,
		"address": "http://vault.service.consul:8200",
		"create_from_role": "nomad-cluster",
		"token": "${nomad_token}"
	},
	"bind_addr": "${private_ip}",
	"region": "${region}"
}
EOF
elif test "$nomad_type" = "slave"; then
	cat > "$json_file" <<EOF
{
	"data_dir": "/opt/nomad/data",
	"consul": {},
	"vault": {
		"enabled": true,
		"address": "http://vault.service.consul:8200",
		"create_from_role": "nomad-cluster",
		"token": "${nomad_token}"
	},
	"bind_addr": "${private_ip}",
	"region": "${region}"
}
EOF
else
	echo "!unknown nomad type!"
	exit 1
fi
# if vault.service.consul does not work, change it to
# http://127.0.0.1:8200

echo "Installing service..."
./service_install "$service" "$user" "$group" "$nomad_version" "$conf_file" "$json_file"

# Clean
function finish {
	./shred "$temp"
}
trap finish EXIT
