#!/usr/bin/bash
set -ueE -o pipefail

# Locals
SERVICE="vault"
USERNAME="vaulty"
GROUP="$USERNAME"

# Variables
pushd /root/cluster/var
VAR_VAULT_VERSION="$(tr -d '\n' < ./vault_version)"
VAR_VAULT_URL="$(tr -d '\n' < ./vault_url)"
VAR_PRIVATE_IP="$(tr -d '\n' < ./private_ip)"
popd

# Configuration of vault is completely automatic thanks to consul
# https://www.vaultproject.io/docs/configuration/storage/consul.html
# but we still need a configuration file apparently...
echo "Writing vault configuration..."
cat >/root/cluster/tmp/vault.conf << EOF
[Unit]
Description=Vault Agent
Requires=network-online.target
After=network-online.target

[Service]
Restart=on-failure
Environment=GOMAXPROCS=nproc
ExecStart=/usr/local/bin/vault server -config=/etc/systemd/system/vault.d
ExecReload=/bin/kill -HUP \$MAINPID
KillSignal=SIGTERM
User=$USERNAME
Group=$GROUP
LimitMEMLOCK=infinity

[Install]
WantedBy=multi-user.target
EOF
cat >/root/cluster/tmp/vault.json << EOF
{
	"listener": {
		"tcp": {
			"address": "$VAR_PRIVATE_IP:8200",
			"cluster_address": "$VAR_PRIVATE_IP:8201",
			"tls_disable": 1
		}
	},
	"storage": {
		"consul": {}
	}
}
EOF

echo "Installing service..."
/root/cluster/scripts/install-service "$USERNAME" "$GROUP" "$SERVICE" "$VAR_VAULT_URL" "$VAR_VAULT_VERSION"
sudo setcap cap_ipc_lock=+ep /usr/local/bin/vault
