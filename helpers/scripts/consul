#!/usr/bin/env bash
set -ueE -o pipefail
cd "$(dirname "$0")"

# Locals
service="consul"
user="root"
group="$user"

# Variables
consul_version="$(tr -d '\n' < ../data/consul_version)"
consul_type="$(tr -d '\n' < ../data/consul_type)"
consul_expect="$(tr -d '\n' < ../data/consul_expect)"
private_ip="$(tr -d '\n' < ../data/private_ip)"
loopback_ip="$(tr -d '\n' < ../data/loopback_ip)"
join="$(tr -d '\n' < ../data/join)"

# Files
temp="$(mktemp -d)"
conf_file="$temp/$service.conf"
json_file="$temp/$service.json"

# "recursors" : [ "8.8.8.8", "8.8.4.4" ],
echo "Writing consul configuration..."
cat > "$conf_file" <<EOF
[Unit]
Description=consul agent
Requires=network-online.target
After=network-online.target

[Service]
Restart=on-failure
EnvironmentFile=-/etc/sysconfig/consul
ExecStart=/usr/local/bin/consul agent -config-dir=/etc/systemd/system/consul.d
ExecReload=/bin/kill -HUP \$MAINPID
KillSignal=SIGTERM
User=${user}
Group=${group}

[Install]
WantedBy=multi-user.target
EOF
if test "$consul_type" = "origin"; then
	cat > "$json_file" <<EOF
{
	"bootstrap": true,
	"server": true,

	"ports" : {
		"dns": 53
	},
	"ui": true,
	"data_dir": "/opt/consul/data",
	"bind_addr": "${private_ip}",
	"client_addr": "${loopback_ip}"
}
EOF
elif test "$consul_type" = "master"; then
	cat > "$json_file" <<EOF
{
	"bootstrap_expect": ${consul_expect},
	"server": true,
	"retry_join": ["${join}"],

	"ports" : {
		"dns": 53
	},
	"ui": true,
	"data_dir": "/opt/consul/data",
	"bind_addr": "${private_ip}",
	"client_addr": "${loopback_ip}"
}
EOF
elif test "$consul_type" = "slave"; then
	cat > "$json_file" <<EOF
{
	"retry_join": ["${join}"],
	"ports" : {
		"dns": 53
	},
	"ui": true,
	"data_dir": "/opt/consul/data",
	"bind_addr": "${private_ip}",
	"client_addr": "${loopback_ip}"
}
EOF
else
	echo "!unknown consul type!"
	exit 1
fi

echo "Configuring Consul DNS access..."
nameserver_config="nameserver ${loopback_ip}"
if grep "$nameserver_config" < /etc/resolv.conf; then
	echo "nameserver already configured"
else
	echo "$nameserver_config" | cat - /etc/resolv.conf > /tmp/resolv.conf && sudo mv /tmp/resolv.conf /etc/resolv.conf
fi
# we can't just do
# sudo echo "nameserver $LOOPBACK_IP" > /etc/resolv.conf
# becasuse /etc/resolv.conf also contains these, which is necessary for scaleway networking perhaps... we could try add them to the consul resolver, but not sure that works
# nameserver 10.1.94.8
# domain cloud.online.net
# search cloud.online.net

echo "Installing service..."
./service_install "$service" "$user" "$group" "$consul_version" "$conf_file" "$json_file"

# Clean
function finish {
	./shred "$temp"
}
trap finish EXIT
