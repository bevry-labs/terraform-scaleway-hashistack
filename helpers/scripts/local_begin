#!/usr/bin/env bash
set -ueE -o pipefail
cd "$(dirname "$0")"

# Variables
public_ip="$(cat ../data/public_ip)"
output_path="$(cat ../data/output_path)"

# Clean output
mkdir -p "$output_path/certs"
mkdir -p "$output_path/terraform"

# Check latest version
./service_latest "consul"
./service_latest "vault"
./service_latest "nomad"

# Known Hosts
echo ""
echo "adding the new host to known hosts"
ssh-keygen -R "$public_ip"
ssh-keyscan "$public_ip" >> "$HOME/.ssh/known_hosts"
./shred "$HOME/.ssh/known_hosts.old"
